<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="payment.css">
  <title>ReniPay</title>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.1/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Reni</h1>
            <h2 >Payment page</h2>
        </header>
        <section class="portfolio">
            <h3>Your portfolio</h3>
            <div class="tokens">
                <marquee>Wallet not connected</marquee>
                <!-- <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div> -->
            </div>
        </section>
        <section class="paymentdetails">
            <h3>Payment Details</h3>
            <form>
                <div class="form-element">
                    <label for="to">Payment to: </label>
                    <input name="to" id="to" value="Hexdee" disabled>
                </div>
                <div class="form-element">
                    <label for="from">From: </label>
                    <input name="from" id="from" value="Please connect wallet" disabled>
                </div>
                <div class="connect" onclick="connect()"><div class="connect-icon"></div>Connect Wallet</div>
                <div class="form-element">
                    <label for="token">Token: </label>
                    <select name="token" id="token">
                        <option value="">Select Token</option>
                        <!-- <option value="bnb">4 BNB</option>
                        <option value="eth">2.3 ETH</option>
                        <option value="eth">98 MATIC</option> -->
                    </select>
                </div>                
                <button type="button" onclick="makePayment()">Pay with Reni</button>
            </form>
        </section>
    </div>
    <script>
         // https://docs.walletconnect.com/quick-start/dapps/web3-provider
        var provider = new WalletConnectProvider.default({
        rpc: {
            //1: "https://cloudflare-eth.com/", // https://ethereumnodes.com/
            //137: "https://polygon-rpc.com/", // https://docs.polygon.technology/docs/develop/network-details/network/
            80001: "https://rpc-mumbai.maticvigil.com/",
            // ...

        },
        // bridge: 'https://bridge.walletconnect.org',
        });

        const setFrom = () => {
            document.getElementById("from").value = account;
        }

        const getTokens = async () => {
            try {
                const url = new URL(`https://deep-index.moralis.io/api/v2/${account}/erc20?chain=mumbai`);
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': '4QdwNluHelpTw9qmoAXTsaodpYXP1E1cpdrRmqbTGf9sPhO9hBFPrRydJxkl5TPP'
                    }
                })
                return res.json();
            } catch (error) {
                console.log(error);
            }
        }

        const setTokens = async () => {
            const tokens = await getTokens(account);
            document.getElementById("token").innerHTML = 
                '<option value="">Select Token</option>' + 
                tokens.map((token) => {
                    return `<option value="${token.token_address}">${token.symbol}</option>`
                })
        }

        const setPortfolio = async () => {
            const tokens = await getTokens(account);
            let tokensElement = "";
            console.log(tokens);
            tokens.map((tkn) => {
                tokensElement += `<div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 ${tkn.symbol}</strong></p>
                    <p>1,217 USD</p>
                    </div>`        
            })
            document.querySelector(".tokens").innerHTML = tokensElement;
        } 

        const init = (account) => {
            if (account) {
                window.account = account;
                setFrom();
                setTokens();
                setPortfolio();
                document.querySelector(".connect").style.display = "none";
            }
        }

        const connect = async() => {
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                init(account);
                window.ethereum.on('accountsChanged', function (accounts) {
                    init(accounts[0]);
                });
            }
            else {
                await provider.enable();

                 //  Create Web3 instance
                const web3 = new Web3(provider);
                window.w3 = web3
                const accounts  = await web3.eth.getAccounts(); // get all connected accounts
                const account = accounts[0];
                init(account);
            }
            
        }

        const makePayment = () => {
            const token = document.getElementById("token").value;
            console.log(token);
        }
    </script>
</body>
</html>
