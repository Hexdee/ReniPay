<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="payment.css">
  <title>ReniPay</title>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.1/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Reni</h1>
            <h2 >Payment page</h2>
        </header>
        <section class="portfolio">
            <h3>Your portfolio</h3>
            <div class="tokens">
                <marquee>Wallet not connected</marquee>
                <!-- <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div>
                <div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 BNB</strong></p>
                    <p>1,217 USD</p>
                </div> -->
            </div>
        </section>
        <section class="paymentdetails">
            <h3>Payment Details</h3>
            <form>
                <div class="form-element">
                    <label for="to">Payment to: </label>
                    <input name="to" id="to" value="Hexdee" disabled>
                </div>
                <div class="form-element">
                    <label for="from">From: </label>
                    <input name="from" id="from" value="Please connect wallet" disabled>
                </div>
                <div class="form-element">
                    <label for="amount">Amount: </label>
                    <input type="number" name="amount" id="amount" value="500" disabled>
                </div>
                <div class="connect" onclick="connect()"><div class="connect-icon"></div>Connect Wallet</div>
                <div class="form-element">
                    <label for="token">Token: </label>
                    <select name="token" id="token">
                        <option value="">Select Token</option>
                        <!-- <option value="bnb">4 BNB</option>
                        <option value="eth">2.3 ETH</option>
                        <option value="eth">98 MATIC</option> -->
                    </select>
                </div>                
                <button type="button" onclick="makePayment()">Pay with Reni</button>
            </form>
        </section>
    </div>
    <script>
        var reniAddress = "0xF0ac04e4938bcf3Ce97717C6249b288c9D2d08Fd";
        var reniAbi = [ {"inputs": [{ "internalType": "address", "name": "_token", "type": "address"}, { "internalType": "uint256", "name": "_amountInUSD", "type": "uint256"}], "name": "makePayment", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_amountInUSD", "type": "uint256"}, { "internalType": "address", "name": "_token", "type": "address" }], "name": "requiredTokenAmount", "outputs": [{ "internalType": "uint256", "name": "_tokenAmount", "type": "uint256"}], "stateMutability": "view", "type": "function"}];
        var erc20Abi = [];
         // https://docs.walletconnect.com/quick-start/dapps/web3-provider
        var provider = new WalletConnectProvider.default({
        rpc: {
            //1: "https://cloudflare-eth.com/", // https://ethereumnodes.com/
            //137: "https://polygon-rpc.com/", // https://docs.polygon.technology/docs/develop/network-details/network/
            80001: "https://rpc-mumbai.maticvigil.com/",
            // ...

        },
        // bridge: 'https://bridge.walletconnect.org',
        });

        const setFrom = () => {
            document.getElementById("from").value = account;
        }

        const getTokens = async () => {
            try {
                const url = new URL(`https://deep-index.moralis.io/api/v2/${account}/erc20?chain=mumbai`);
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': '4QdwNluHelpTw9qmoAXTsaodpYXP1E1cpdrRmqbTGf9sPhO9hBFPrRydJxkl5TPP'
                    }
                })
                return res.json();
            } catch (error) {
                console.log(error);
            }
        }

        const setTokens = async () => {
            const tokens = await getTokens(account);
            document.getElementById("token").innerHTML = 
                '<option value="">Select Token</option>' + 
                tokens.map((token) => {
                    return `<option value="${token.token_address}">${token.symbol}</option>`
                })
        }

        const setPortfolio = async () => {
            const tokens = await getTokens(account);
            let tokensElement = "";
            console.log(tokens);
            tokens.map((tkn) => {
                tokensElement += `<div class="token">
                    <div class="token-img"></div>
                    <p><strong>4 ${tkn.symbol}</strong></p>
                    <p>1,217 USD</p>
                    </div>`        
            })
            document.querySelector(".tokens").innerHTML = tokensElement;
        } 

        const init = (account) => {
            if (account) {
                window.account = account;
                setFrom();
                setTokens();
                setPortfolio();
                document.querySelector(".connect").style.display = "none";
            }
        }

        const connect = async() => {
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                init(account);
                web3 = new Web3(window.ethereum);
                window.w3 = web3;
                window.ethereum.on('accountsChanged', function (accounts) {
                    init(accounts[0]);
                });
            }
            else {
                if(provider.connected) {
                    await provider.disconnect();
                }
                await provider.enable();

                 //  Create Web3 instance
                const web3 = new Web3(provider);
                window.w3 = web3;
                const accounts  = await web3.eth.getAccounts(); // get all connected accounts
                const account = accounts[0];
                console.log(await web3.eth.getChainId())
                init(account);
                provider.on("accountsChanged", (accounts) => {
                    init(accounts[0])
                });

            }
            
        }

        const sign = async (msg) => {
            if (w3) {
            return await w3.eth.personal.sign(msg, account);
            } else {
                return false
            }
        }

        const contract = async (abi, address) => {
            if (w3) {
                return new w3.eth.Contract(abi, address)
            } else {
                return false
            }
        }

        var disconnect = async () => {
            // Close provider session
            await provider.disconnect()
        }


    var address = "0x4b4f8ca8fb3e66b5ddafcebfe86312cec486dae1"
    var abi = [{"inputs":[],"name":"count","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"increment","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}]


        const makePayment = async() => {
            const token = document.getElementById("token").value;
            const amount = document.getElementById("amount").value;
            console.log("abi", reniAbi);
            console.log("address", reniAddress);
            console.log("token", token);
            if(token) {
                console.log(token);
                const reni = await contract(reniAbi, reniAddress);
                console.log("reni", reni);
                const tx = await reni.methods.makePayment(token, amount).send({ from: account });
                console.log(tx);
                console.log("tx.wait: ", tx.wait)
            }
            else {
                alert("Please select a token");
            }
        }
    </script>
</body>
</html>
